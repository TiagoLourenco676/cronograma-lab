<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocupa√ß√£o e hist√≥rico Advanced Labs</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #0056b3; --success: #28a745; --info: #17a2b8; --warning: #ffc107; --danger: #dc3545; --bg: #f4f6f8; --card: #ffffff; --border: #dde2e6; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1250px; margin: 0 auto; background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        
        /* HEADER */
        header { border-bottom: 1px solid #eee; margin-bottom: 20px; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { margin: 0; color: var(--primary); font-size: 1.4rem; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* TABS */
        .tab-menu { display: flex; gap: 5px; background: #e9ecef; padding: 5px; border-radius: 8px; }
        .tab-btn { padding: 8px 16px; border: none; background: transparent; cursor: pointer; border-radius: 6px; font-weight: 600; color: #666; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .tab-btn:hover { background: rgba(255,255,255,0.5); }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: 200px 200px 1fr; gap: 15px; margin-bottom: 25px; }
        .dash-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .dash-val { display: block; font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .dash-label { font-size: 0.7rem; text-transform: uppercase; color: #666; font-weight: 700; margin-top: 5px; }
        
        /* PREVIS√ÉO POR PROCESSO CONTAINER */
        .process-forecast-container { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 8px; max-height: 120px; overflow-y: auto; }
        .forecast-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 12px; border-radius: 4px; border-left: 4px solid var(--info); font-size: 0.85rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .forecast-date { font-weight: bold; color: var(--primary); }

        /* CONTROLS */
        .controls { background: #e9ecef; padding: 15px; border-radius: 8px; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 0.75rem; font-weight: 700; color: #555; margin-bottom: 4px; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        
        button { padding: 9px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-add { background: var(--info); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-manage { background: #6c757d; color: white; }
        .btn-icon { padding: 5px; background: transparent; color: #666; font-size: 1.1rem; } .btn-icon:hover { transform: scale(1.1); }

        /* TABLES */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 20px; font-size: 0.9rem; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        
        /* ITEM CARDS */
        .checklist-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: white; border: 1px solid #eee; border-radius: 6px; transition: 0.2s; margin-bottom: 4px; }
        .checklist-item:hover { border-color: #beccdb; background: #f8f9fa; }
        .checklist-item.priority { border-left: 4px solid var(--warning); background: #fffdf5; }
        
        .item-check { width: 20px; height: 20px; cursor: pointer; accent-color: var(--success); }
        .item-title { font-weight: 600; color: #333; display: flex; align-items: center; gap: 8px; }
        .item-meta { font-size: 0.75rem; color: #666; margin-top: 2px; display: flex; gap: 8px; flex-wrap: wrap; }
        
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .tag-sample { background: #e2e6ea; color: #555; }
        .tag-process { background: #cff4fc; color: #055160; border: 1px solid #b6effb; }
        
        /* FAIL STATE */
        .failed-row { background-color: #ffeaea !important; }
        .failed-row td { color: #721c24; }
        .btn-fail { color: #dc3545; background: none; border: 1px solid #dc3545; border-radius: 4px; padding: 2px 6px; font-size: 0.8rem; cursor: pointer; }
        .btn-fail:hover { background: #dc3545; color: white; }

        input.date-edit { border: none; background: transparent; font-family: inherit; font-size: 0.9rem; color: #333; cursor: pointer; border-bottom: 1px dashed #ccc; width: 135px; }
        input.date-edit:focus { outline: none; border-bottom: 2px solid var(--primary); background: #fff; }
        .obs-input { width: 95%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; color: #555; }

        /* LOADING */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODALS */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; }
        .modal { background:white; padding:25px; border-radius:8px; width:90%; max-width:500px; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
        
        /* PERFORMANCE */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-ok { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }

        @media print { .controls, .tab-menu, button { display: none; } .tab-content { display: block !important; } }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:600; color:#555;">Sincronizando Advanced Labs...</div>
</div>

<div class="container">
    <header>
        <h1><i class="fas fa-microscope"></i> Ocupa√ß√£o e Hist√≥rico Advanced Labs</h1>
        <div class="tab-menu">
            <button class="tab-btn active" onclick="switchTab('cronograma')"><i class="fas fa-calendar-alt"></i> Cronograma</button>
            <button class="tab-btn" onclick="switchTab('historico')"><i class="fas fa-history"></i> Hist√≥rico</button>
            <button class="tab-btn" onclick="switchTab('performance')"><i class="fas fa-chart-line"></i> Performance</button>
        </div>
    </header>

    <div id="tab-cronograma" class="tab-content active">
        <div class="dashboard-grid">
            <div class="dash-card">
                <span class="dash-val" id="valRemaining">--</span>
                <span class="dash-label">Fila (Pendentes)</span>
            </div>
            <div class="dash-card">
                <span class="dash-val" id="valDone" style="color:var(--success)">--</span>
                <span class="dash-label">Realizados</span>
            </div>
            <div class="process-forecast-container" id="forecastContainer">
                <div style="text-align:center; color:#999; font-size:0.9rem; padding:10px;">Calculando previs√µes...</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Data Base (Hoje):</label>
                <input type="date" id="startDate" onchange="renderApp()">
            </div>
            <div class="control-group">
                <label>Meta Di√°ria:</label>
                <input type="number" id="dailyLimit" value="4" min="1" style="width: 60px;" onchange="renderApp()">
            </div>
            <button class="btn-primary" onclick="location.reload()">üîÑ Sincronizar</button>
            <button class="btn-add" onclick="openAddModal()">‚ûï Novo Ensaio</button>
            <button class="btn-manage" onclick="openManagerModal()">‚öôÔ∏è Gerenciar</button>
        </div>

        <h3>üìÖ Fila de Trabalho</h3>
        <table id="pendingTable">
            <thead><tr><th width="15%">Previs√£o</th><th width="10%">Dia</th><th>Amostras na Fila</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tab-historico" class="tab-content">
        <div class="controls" style="background: white; border: 1px solid #eee; justify-content: space-between;">
            <h3 style="margin:0;">‚úÖ Hist√≥rico de Ensaios</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-success" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Excel</button>
                <button class="btn-danger" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
        </div>
        <table id="completedTable">
            <thead><tr><th width="18%">Data Realizada ‚úèÔ∏è</th><th>Processo / Modelo</th><th width="40%">Observa√ß√µes / Justificativa</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tab-performance" class="tab-content">
        <div class="dashboard-grid">
            <div class="dash-card"><span class="dash-val" id="perfAvg">--</span><span class="dash-label">M√©dia Real</span></div>
            <div class="dash-card"><span class="dash-val" id="perfEff">--%</span><span class="dash-label">Efici√™ncia</span></div>
            <div class="dash-card" style="align-items: flex-start; text-align: left; padding-left: 20px;">
                <span style="font-size:0.9rem; color:#666;">‚ÑπÔ∏è Ensaios com falha contam na performance pois consumiram tempo de m√°quina.</span>
            </div>
        </div>
        
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-top:20px;">
             <div style="background:white; padding:20px; border:1px solid #ddd; border-radius:8px; height:350px; position:relative;">
                <h4 style="margin-top:0;">Evolu√ß√£o Di√°ria</h4>
                <div style="height:280px; position:relative;"><canvas id="perfChart"></canvas></div>
            </div>
            <div style="background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffeeba; font-size:0.9rem;">
                <h4 style="margin-top:0; color:#856404;">üìù Instru√ß√µes</h4>
                <p>Use a tabela abaixo para justificar dias onde a meta n√£o foi batida.</p>
            </div>
        </div>

        <h3 style="margin-top:30px;">Di√°rio de Ocorr√™ncias</h3>
        <table class="log-table">
            <thead><tr><th>Data</th><th>Meta</th><th>Realizado</th><th>Status</th><th>Justificativa</th></tr></thead>
            <tbody id="logTableBody"></tbody>
        </table>
    </div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal">
        <h3>Adicionar Novo Ensaio</h3>
        <label>Nome do Processo (Projeto):</label>
        <input type="text" id="newProcessName" style="width:100%; margin-bottom:10px;" placeholder="Ex: Processo 2024Ele...">
        
        <label>Modelo da Lumin√°ria:</label>
        <input type="text" id="newModelName" style="width:100%; margin-bottom:10px;" placeholder="Ex: LED 100W 5K">
        
        <label>Quantidade de Amostras:</label>
        <input type="number" id="newModelCount" value="3" style="width:100%; margin-bottom:20px;">
        
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn-danger" onclick="closeModals()">Cancelar</button>
            <button class="btn-primary" onclick="addNewModel()">Salvar</button>
        </div>
    </div>
</div>

<div id="managerModal" class="modal-overlay">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Gerenciar Itens</h3>
            <button class="btn-danger" style="padding:5px 10px;" onclick="closeModals()">X</button>
        </div>
        <div id="managerList" style="max-height:400px; overflow-y:auto; border:1px solid #eee; border-radius:4px;"></div>
    </div>
</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è CONFIGURA√á√ÉO DO SUPABASE
    // ==========================================
    const SUPABASE_URL = 'https://uzftppvvshpyoejmptjm.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6ZnRwcHZ2c2hweW9lam1wdGptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODU4NjgsImV4cCI6MjA4NDE2MTg2OH0.lnB46eC4dwQpRYdeJreNLu8vOMGED2GOBLOoO3vnPIs';
    // ==========================================

    let labDB = null;
    let globalItems = [];
    let globalLogs = new Map();
    let performanceChart = null;
    const TABLE_MAIN = 'cronograma_lab';
    const TABLE_LOGS = 'daily_logs';

    // Lista Base Legado (Agora assumimos que fazem parte de um Processo Padr√£o se n√£o tiverem nome)
    const baseModelsList = [
        "IL-MIR 150W_5K", "IL-MIR 80W_5K", "IL-MIR 136W_5K", "IL-MIR 115W_5K", "IL-MIR 100W_5K", "IL-MIR 70W_5K", "IL-MIR 60W_5K", "IL-MIR_50W_5K", "IL-MIR 40W 5K", "IL-MIR 30W 5K",
        "IL-MIR 150W_4K", "IL-MIR 80W_4K", "IL-MIR 136W_4K", "IL-MIR 115W_4K", "IL-MIR 100W 4K", "IL-MIR_70W 4K", "IL-MIR_60W_4K", "IL-MIR_50W_4K", "IL-MIR 40W 4K", "IL-MIR 30W 4K",
        "IL-MIR 150W_2,7K", "IL-MIR 80W_2,7K", "IL-MIR 136W_2,7K", "IL-MIR 115W_2,7K", "IL-MIR 100W 2,7K", "IL-MIR 70W_2,7K", "IL-MIR 60W 2.7K", "IL-MIR 50W 2,7K", "IL-MIR 40W_2,7K", "IL-MIR 30W_2,7K"
    ];

    window.onload = async function() {
        if(SUPABASE_URL.includes('COLE_SUA_URL')) { alert("Configure as chaves!"); return; }
        labDB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        document.getElementById('startDate').value = localStorage.getItem('fq53_start') || new Date().toISOString().split('T')[0];
        document.getElementById('dailyLimit').value = localStorage.getItem('fq53_limit') || 4;

        await fetchData();
    };

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        if(tab === 'performance') renderPerformance();
    }

    async function fetchData() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        const { data: items } = await labDB.from(TABLE_MAIN).select('*');
        const { data: logs } = await labDB.from(TABLE_LOGS).select('*');

        globalItems = [];
        const dbMap = new Map((items||[]).map(i => [i.id, i]));

        // Base Models (Legado)
        baseModelsList.forEach((model, mIdx) => {
            for(let i=1; i<=3; i++) {
                let id = `chk_${mIdx}_${i}`;
                let dbData = dbMap.get(id);
                if (dbData && dbData.is_deleted) continue; 
                // Se n√£o tem dbData, usa defaults. Se tem, usa o processo salvo ou 'Geral'
                let proc = dbData ? (dbData.process_name || 'Geral') : 'Geral';
                globalItems.push(createItemObj(id, model, i, 3, false, dbData, proc));
            }
        });

        // Custom Models
        (items||[]).forEach(item => {
            if (item.is_custom && !item.is_deleted) {
                globalItems.push(createItemObj(item.id, item.model, item.sample_num, item.total_samples, true, item, item.process_name || 'Geral'));
            }
        });

        globalLogs = new Map();
        (logs||[]).forEach(l => globalLogs.set(l.date, l.obs));

        renderApp();
        renderPerformance();
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function createItemObj(id, model, num, total, isCustom, dbData, processName) {
        return {
            id: id, model: model, sampleNum: num, totalSamples: total, isCustom: isCustom,
            isFirst: num === 1,
            done: dbData ? dbData.done : false,
            doneDate: dbData ? dbData.done_date : null,
            obs: dbData ? dbData.obs : "",
            priority: dbData ? dbData.is_priority : false,
            process: processName,
            isFailed: dbData ? dbData.is_failed : false
        };
    }

    function renderApp() {
        const startStr = document.getElementById('startDate').value;
        const limit = parseInt(document.getElementById('dailyLimit').value);
        localStorage.setItem('fq53_start', startStr); localStorage.setItem('fq53_limit', limit);

        // Sorting
        let pending = globalItems.filter(i => !i.done).sort((a,b) => (b.priority ? 1 : 0) - (a.priority ? 1 : 0));
        let completed = globalItems.filter(i => i.done).sort((a,b) => new Date(b.doneDate||0) - new Date(a.doneDate||0));

        document.getElementById('valRemaining').innerText = pending.length;
        document.getElementById('valDone').innerText = completed.length;

        // --- PREDICTION LOGIC PER PROCESS ---
        const tbody = document.querySelector('#pendingTable tbody');
        tbody.innerHTML = '';
        let currentDate = new Date(startStr + 'T00:00:00');
        let today = new Date(); today.setHours(0,0,0,0);
        let qIdx = 0;
        
        let processEndDates = {}; // Map to track end date per process

        if(pending.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" align="center">üéâ Tudo pronto!</td></tr>';
            document.getElementById('forecastContainer').innerHTML = '<div style="padding:10px; text-align:center;">Sem pend√™ncias.</div>';
        } else {
            while(qIdx < pending.length) {
                while(currentDate.getDay()===0 || currentDate.getDay()===6) currentDate.setDate(currentDate.getDate()+1);
                
                const dateKey = currentDate.toISOString().split('T')[0];
                const isToday = currentDate.getTime() === today.getTime();
                
                let slots = limit;
                if(isToday) {
                    const doneToday = completed.filter(i => i.doneDate === dateKey).length;
                    slots = Math.max(0, limit - doneToday);
                }
                if(currentDate < today) slots = 0; 

                let batch = [];
                for(let i=0; i<slots; i++) {
                    if(qIdx < pending.length) { 
                        let item = pending[qIdx];
                        batch.push(item);
                        // Update process prediction
                        processEndDates[item.process] = new Date(currentDate);
                        qIdx++; 
                    }
                }

                if(batch.length > 0) {
                    const tr = document.createElement('tr');
                    const dateFmt = currentDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                    if(isToday) tr.style.backgroundColor = '#e8f0fe';
                    
                    let html = batch.map(item => `
                        <div class="checklist-item ${item.priority ? 'priority' : ''}">
                            <input type="checkbox" class="item-check" onclick="toggleItem('${item.id}')" title="Marcar como OK">
                            
                            <button class="btn-fail" onclick="markAsFailed('${item.id}')" title="Marcar Falha/Erro">‚ö†Ô∏è</button>

                            <div style="flex-grow:1">
                                <div class="item-title">
                                    ${item.model} 
                                    <i class="fas fa-star ${item.priority?'text-warning':''}" 
                                       style="cursor:pointer; color:${item.priority?'#ffc107':'#ddd'}" 
                                       onclick="togglePriority('${item.id}')"></i>
                                </div>
                                <div class="item-meta">
                                    <span class="tag tag-process">${item.process}</span>
                                    <span class="tag tag-sample">${item.sampleNum}/${item.totalSamples}</span>
                                </div>
                            </div>
                            <input type="text" class="obs-input" placeholder="Obs..." value="${item.obs||''}" onchange="saveObs('${item.id}', this.value)">
                        </div>
                    `).join('');

                    tr.innerHTML = `<td>${dateFmt}</td><td>${isToday ? '<b>HOJE</b>' : 'Futuro'}</td><td>${html}</td>`;
                    tbody.appendChild(tr);
                }
                currentDate.setDate(currentDate.getDate()+1);
            }
            
            // Render Process Forecasts
            const forecastDiv = document.getElementById('forecastContainer');
            forecastDiv.innerHTML = '';
            // Sort keys just to look nice
            Object.keys(processEndDates).sort().forEach(procName => {
                const d = processEndDates[procName];
                const dateStr = d.toLocaleDateString('pt-BR');
                const diffTime = d - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const label = diffDays > 0 ? `(em ${diffDays} dias)` : '(Hoje)';
                
                forecastDiv.innerHTML += `
                    <div class="forecast-row">
                        <span>${procName}</span>
                        <span class="forecast-date">Termina: ${dateStr} <small>${label}</small></span>
                    </div>`;
            });
        }

        // Render Realizados (Com Destaque para Falhas)
        const doneBody = document.querySelector('#completedTable tbody');
        doneBody.innerHTML = '';
        completed.forEach(item => {
            const tr = document.createElement('tr');
            if (item.isFailed) tr.className = 'failed-row';
            
            let statusIcon = item.isFailed ? '‚ö†Ô∏è <b style="color:#721c24;">FALHA</b>' : '‚úÖ OK';

            tr.innerHTML = `
                <td><input type="date" class="date-edit" value="${item.doneDate||''}" onchange="updateDate('${item.id}', this.value)"></td>
                <td>
                    <div style="display:flex; flex-direction:column;">
                        <b>${item.model}</b>
                        <small style="color:#666">${item.process} | Amostra ${item.sampleNum}</small>
                    </div>
                </td>
                <td>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>${statusIcon}</span>
                        <input type="text" class="obs-input" value="${item.obs||''}" onchange="saveObs('${item.id}', this.value)" 
                               placeholder="${item.isFailed ? 'Justificativa da falha obrigat√≥ria' : 'Observa√ß√µes'}">
                        
                        ${!item.isFailed ? `<button class="btn-danger" style="font-size:0.7rem; padding:2px 5px;" onclick="toggleItem('${item.id}')">Desfazer</button>` : `<button class="btn-danger" style="font-size:0.7rem; padding:2px 5px;" onclick="undoFail('${item.id}')">Desfazer</button>`}
                    </div>
                </td>
            `;
            doneBody.appendChild(tr);
        });
    }

    // --- ACTIONS ---
    
    // Sucesso Normal
    async function toggleItem(id) {
        const item = globalItems.find(i => i.id === id);
        const newState = !item.done;
        // Se estava 'failed' e o usu√°rio clicou no check, reseta falha
        item.isFailed = false; 
        item.done = newState;
        item.doneDate = item.done ? new Date().toISOString().split('T')[0] : null;
        renderApp(); renderPerformance();
        await dbUpsert(item);
    }

    // Marcar como Falha (Consome slot mas marca erro)
    async function markAsFailed(id) {
        const reason = prompt("‚ö†Ô∏è REGISTRO DE FALHA\n\nPor favor, descreva o motivo da falha (ex: queima prematura, erro de montagem):");
        if (!reason || reason.trim() === "") {
            alert("A justificativa √© obrigat√≥ria para registrar uma falha.");
            return;
        }

        const item = globalItems.find(i => i.id === id);
        item.done = true;
        item.doneDate = new Date().toISOString().split('T')[0];
        item.isFailed = true;
        item.obs = "[FALHA] " + reason;
        
        renderApp(); renderPerformance();
        await dbUpsert(item);
    }

    async function undoFail(id) {
        if(!confirm("Deseja desfazer este registro de falha e voltar para a fila?")) return;
        const item = globalItems.find(i => i.id === id);
        item.done = false;
        item.isFailed = false;
        item.doneDate = null;
        renderApp(); renderPerformance();
        await dbUpsert(item);
    }

    async function togglePriority(id) {
        const item = globalItems.find(i => i.id === id);
        item.priority = !item.priority;
        renderApp(); await dbUpsert(item);
    }

    async function updateDate(id, newDate) {
        const item = globalItems.find(i => i.id === id);
        if(!newDate) return;
        item.doneDate = newDate;
        renderApp(); renderPerformance(); await dbUpsert(item);
    }

    async function saveObs(id, text) {
        const item = globalItems.find(i => i.id === id);
        item.obs = text; await dbUpsert(item);
    }

    // --- DB HELPERS ---
    async function dbUpsert(item) {
        const payload = {
            id: item.id, model: item.model, sample_num: item.sampleNum,
            total_samples: item.totalSamples, is_custom: item.isCustom,
            done: item.done, done_date: item.doneDate, obs: item.obs, 
            is_priority: item.priority, process_name: item.process, // NOVA COLUNA
            is_failed: item.isFailed // NOVA COLUNA
        };
        await labDB.from(TABLE_MAIN).upsert(payload);
    }

    async function addNewModel() {
        const proc = document.getElementById('newProcessName').value.trim() || "Geral";
        const name = document.getElementById('newModelName').value.trim();
        const count = document.getElementById('newModelCount').value;
        if(!name) return;
        
        const baseId = 'custom_' + Date.now();
        const inserts = [];
        for(let i=1; i<=count; i++) inserts.push({ 
            id: `${baseId}_${i}`, model: name, sample_num: i, total_samples: count, 
            is_custom: true, done: false, done_date: null, obs: "", is_priority: false, is_deleted: false,
            process_name: proc, is_failed: false
        });
        
        await labDB.from(TABLE_MAIN).insert(inserts);
        closeModals(); fetchData();
    }

    async function deleteModel(modelName) {
        if(!confirm(`Excluir modelo "${modelName}"?`)) return;
        const itemsToDelete = globalItems.filter(i => i.model === modelName);
        for (let item of itemsToDelete) {
            item.is_deleted = true; // Local update
            await labDB.from(TABLE_MAIN).update({ is_deleted: true }).eq('id', item.id);
        }
        closeModals(); fetchData();
    }

    // --- MODALS & EXTRAS ---
    function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
    function openManagerModal() {
        const listDiv = document.getElementById('managerList');
        listDiv.innerHTML = '';
        const uniqueModels = [...new Set(globalItems.map(i => i.model))];
        uniqueModels.forEach(modelName => {
            const item = globalItems.find(i => i.model === modelName);
            listDiv.innerHTML += `
                <div class="checklist-item" style="justify-content:space-between;">
                    <div><strong>${modelName}</strong> <span class="tag tag-sample">${item.process}</span></div>
                    <button class="btn-danger" style="padding:4px 8px; font-size:0.8rem;" onclick="deleteModel('${modelName}')">üóëÔ∏è</button>
                </div>`;
        });
        document.getElementById('managerModal').style.display = 'flex';
    }

    async function secureReset() {
        if(prompt("Senha:") === "admin123") {
            await labDB.from(TABLE_MAIN).delete().neq('id', '0');
            await labDB.from(TABLE_LOGS).delete().neq('date', '0');
            location.reload();
        }
    }

    // --- PERFORMANCE & CHARTS ---
    function renderPerformance() {
        const startStr = document.getElementById('startDate').value;
        const limit = parseInt(document.getElementById('dailyLimit').value);
        const today = new Date(); today.setHours(0,0,0,0);
        let loopDate = new Date(startStr + 'T00:00:00');
        const daysData = [];
        let totalDone = 0, daysCounted = 0;

        while(loopDate <= today) {
            if(loopDate.getDay() !== 0 && loopDate.getDay() !== 6) {
                const dateKey = loopDate.toISOString().split('T')[0];
                // Count both success AND failed as work done
                const count = globalItems.filter(i => i.doneDate === dateKey).length;
                daysData.push({ date: dateKey, dateObj: new Date(loopDate), count: count, target: limit, log: globalLogs.get(dateKey) || "" });
                if(loopDate < today) { totalDone += count; daysCounted++; }
            }
            loopDate.setDate(loopDate.getDate() + 1);
        }

        document.getElementById('perfAvg').innerText = daysCounted > 0 ? (totalDone / daysCounted).toFixed(1) : "0.0";
        document.getElementById('perfEff').innerText = daysCounted > 0 ? Math.round(((totalDone / daysCounted) / limit) * 100) + "%" : "0%";

        const logBody = document.getElementById('logTableBody');
        logBody.innerHTML = '';
        [...daysData].reverse().forEach(d => {
            const isToday = d.dateObj.getTime() === today.getTime();
            let statusBadge = isToday ? '<span class="badge badge-warning">...</span>' : (d.count >= d.target ? '<span class="badge badge-ok">OK</span>' : '<span class="badge badge-danger">Baixo</span>');
            const row = `<tr><td>${d.dateObj.toLocaleDateString('pt-BR')}</td><td>${d.target}</td><td>${d.count}</td><td>${statusBadge}</td><td><input type="text" class="obs-input" value="${d.log}" onchange="saveLog('${d.date}', this.value)"></td></tr>`;
            logBody.innerHTML += row;
        });
        updateChart(daysData);
    }

    function updateChart(data) {
        const ctx = document.getElementById('perfChart').getContext('2d');
        if(performanceChart) performanceChart.destroy();
        const recent = data.slice(-14);
        performanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: recent.map(d => d.dateObj.toLocaleDateString('pt-BR', {day:'2-digit',month:'2-digit'})),
                datasets: [{ label: 'Realizado', data: recent.map(d=>d.count), backgroundColor: '#0056b3' }, { label: 'Meta', data: recent.map(d=>d.target), type: 'line', borderColor: '#28a745' }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    // --- EXPORTS ---
    function exportExcel() { /* Mesma l√≥gica V10 */ 
        if(globalItems.filter(i=>i.done).length === 0) return alert("Nada para exportar.");
        const wb = XLSX.utils.book_new();
        const doneData = globalItems.filter(i => i.done).map(i => ({ "Data": i.doneDate, "Processo": i.process, "Modelo": i.model, "Amostra": i.sampleNum, "Status": i.isFailed?"FALHA":"OK", "Obs": i.obs }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(doneData), "Hist√≥rico");
        XLSX.writeFile(wb, "Hist√≥rico_AdvancedLabs.xlsx");
    }
    function exportPDF() { /* Mesma l√≥gica V10 */
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.text("Hist√≥rico Advanced Labs", 14, 20);
        const data = globalItems.filter(i=>i.done).map(i=>[i.doneDate||'-', i.process, i.model, i.isFailed?'FALHA':'OK', i.obs||'']);
        doc.autoTable({ startY: 30, head: [['Data', 'Processo', 'Modelo', 'Status', 'Obs']], body: data });
        doc.save("Relatorio_AdvancedLabs.pdf");
    }
    
    async function saveLog(d, v) { globalLogs.set(d, v); await labDB.from(TABLE_LOGS).upsert({date: d, obs: v}); }
</script>

</body>
</html>
