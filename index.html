<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Lab FQ-053 (Performance)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        :root { --primary: #0056b3; --success: #28a745; --info: #17a2b8; --warning: #ffc107; --danger: #dc3545; --bg: #f4f6f8; --card: #ffffff; --border: #dde2e6; --text: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        
        /* HEADER & TABS */
        header { border-bottom: 1px solid #eee; margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        h1 { margin: 0; color: var(--primary); font-size: 1.6rem; letter-spacing: -0.5px; }
        .tab-menu { display: flex; gap: 10px; margin-top: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: #e9ecef; cursor: pointer; border-radius: 6px; font-weight: 600; color: #666; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD CARDS */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .dash-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; overflow: hidden; }
        .dash-card.highlight { border-color: var(--primary); background: #f0f7ff; }
        .dash-val { display: block; font-size: 2rem; font-weight: 800; color: var(--primary); line-height: 1.2; }
        .dash-label { font-size: 0.75rem; text-transform: uppercase; color: #666; font-weight: 700; letter-spacing: 0.5px; margin-top: 5px; }
        .dash-sub { font-size: 0.85rem; color: #888; margin-top: 5px; }

        /* CONTROLS & INPUTS */
        .controls { background: #e9ecef; padding: 15px; border-radius: 8px; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px; }
        .control-group { display: flex; flex-direction: column; }
        label.ctrl-label { font-weight: 600; font-size: 0.8rem; margin-bottom: 4px; color: #555; }
        input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        button { padding: 9px 18px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-action { background: var(--primary); color: white; } .btn-action:hover { background: #004494; }
        .btn-add { background: var(--info); color: white; } .btn-add:hover { background: #117a8b; }
        .btn-danger { background: var(--danger); color: white; } .btn-danger:hover { background: #bd2130; }

        /* TABLE STYLES */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 20px; font-size: 0.95rem; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background-color: #fafafa; }
        
        /* STATUS BADGES */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-ok { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }

        /* CHECKLIST ITEMS */
        .checklist-item { display: flex; align-items: center; gap: 10px; padding: 8px; border: 1px solid transparent; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .checklist-item:hover { background: #f8f9fa; border-color: #dee2e6; }
        .item-check { width: 20px; height: 20px; accent-color: var(--success); cursor: pointer; }
        .item-tags { display: flex; gap: 5px; font-size: 0.75rem; }
        .tag { padding: 2px 6px; border-radius: 4px; background: #e2e6ea; color: #555; font-weight: 600; }
        .tag-new { background: var(--success); color: white; }
        .obs-input { flex-grow: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; color: #555; }

        /* PERFORMANCE SECTION */
        .perf-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
        .log-table input { width: 100%; box-sizing: border-box; border: 1px solid #ddd; padding: 8px; }
        .log-table input:focus { border-color: var(--warning); outline: none; background: #fffdf5; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.2rem; color: var(--primary); font-weight: bold; }

        @media (max-width: 768px) { .perf-grid { grid-template-columns: 1fr; } .controls { flex-direction: column; align-items: stretch; } }
        @media print { .controls, .tab-menu, button { display: none; } .tab-content { display: block !important; } }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div>Conectando ao Laborat√≥rio...</div>
    <div style="font-size:0.9rem; font-weight:normal; margin-top:10px; color:#666;">Calculando ocupa√ß√£o e performance</div>
</div>

<div class="container">
    <header>
        <div>
            <h1>Lab FQ-053 <span style="font-size:0.5em; background:var(--info); color:white; padding:3px 6px; border-radius:4px; vertical-align:middle;">GEST√ÉO</span></h1>
            <div style="color:#666; font-size:0.9rem; margin-top:5px;">Processo 2024Ele278 | Controle de Ocupa√ß√£o</div>
        </div>
        <div class="tab-menu">
            <button class="tab-btn active" onclick="switchTab('cronograma')">üìÖ Cronograma</button>
            <button class="tab-btn" onclick="switchTab('performance')">üìä Ocupa√ß√£o & Di√°rio</button>
        </div>
    </header>

    <div id="tab-cronograma" class="tab-content active">
        <div class="dashboard">
            <div class="dash-card">
                <span class="dash-val" id="valTotal">--</span>
                <span class="dash-label">Total Amostras</span>
            </div>
            <div class="dash-card">
                <span class="dash-val" id="valDone" style="color:var(--success);">--</span>
                <span class="dash-label">Realizados</span>
            </div>
            <div class="dash-card">
                <span class="dash-val" id="valRemaining">--</span>
                <span class="dash-label">Fila (Pendentes)</span>
            </div>
            <div class="dash-card highlight">
                <span class="dash-val" id="valFinishDate">--/--</span>
                <span class="dash-label">Goniofot√¥metro Ocupado At√©</span>
                <div class="dash-sub" id="valDaysLeft">-- dias √∫teis restantes</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label class="ctrl-label">In√≠cio do Projeto:</label>
                <input type="date" id="startDate" onchange="renderApp()">
            </div>
            <div class="control-group">
                <label class="ctrl-label">Meta Di√°ria (Amostras):</label>
                <input type="number" id="dailyLimit" value="4" min="1" style="width: 80px;" onchange="renderApp()">
            </div>
            <button class="btn-action" onclick="location.reload()">üîÑ Sincronizar</button>
            <button class="btn-add" onclick="addNewModelPrompt()">‚ûï Adicionar Modelo</button>
            <button class="btn-danger" style="margin-left:auto;" onclick="secureReset()">‚ö†Ô∏è Resetar</button>
        </div>

        <h2>üìÖ Fila de Trabalho (A Fazer)</h2>
        <table id="pendingTable">
            <thead><tr><th width="15%">Data Prevista</th><th width="15%">Dia</th><th>Amostras Alocadas</th></tr></thead>
            <tbody></tbody>
        </table>

        <h2 style="margin-top:40px; border-left-color:var(--success);">‚úÖ Hist√≥rico de Realiza√ß√£o</h2>
        <table id="completedTable">
            <thead><tr><th width="15%">Data Realizada</th><th>Amostra</th><th width="40%">Observa√ß√µes T√©cnicas</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tab-performance" class="tab-content">
        <div class="dashboard">
            <div class="dash-card">
                <span class="dash-val" id="perfAvg">--</span>
                <span class="dash-label">M√©dia Real (Amostras/Dia)</span>
            </div>
            <div class="dash-card">
                <span class="dash-val" id="perfTarget">--</span>
                <span class="dash-label">Meta Definida</span>
            </div>
            <div class="dash-card" id="perfStatusCard">
                <span class="dash-val" id="perfEfficiency">--%</span>
                <span class="dash-label">Efici√™ncia Global</span>
            </div>
        </div>

        <div class="perf-grid">
            <div style="background:white; padding:20px; border:1px solid #ddd; border-radius:8px;">
                <h3 style="margin-top:0;">Evolu√ß√£o Di√°ria (Realizado vs Meta)</h3>
                <canvas id="perfChart" height="150"></canvas>
            </div>

            <div style="background:#fff3cd; padding:20px; border-radius:8px; border:1px solid #ffeeba;">
                <h3 style="margin-top:0; color:#856404;">üìù Instru√ß√µes de Controle</h3>
                <p><strong>1. Registro Di√°rio:</strong> O sistema calcula automaticamente o realizado com base nos "checks" dados na aba Cronograma.</p>
                <p><strong>2. Justificativa:</strong> Se a meta n√£o foi atingida em um dia passado, o campo ficar√° <span style="background:#f8d7da; padding:2px 5px; font-weight:bold;">Vermelho</span>. Digite o motivo (ex: "Manuten√ß√£o", "Feriado") e o sistema salva automaticamente.</p>
                <p><strong>3. Ocupa√ß√£o:</strong> A data final √© recalculada dinamicamente baseada na meta configurada.</p>
            </div>
        </div>

        <h2 style="margin-top:30px;">üìñ Di√°rio de Bordo (Justificativas de Atraso)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th width="15%">Data</th>
                    <th width="10%">Meta</th>
                    <th width="10%">Realizado</th>
                    <th width="15%">Status</th>
                    <th>Justificativa / Ocorr√™ncias (Digitar para salvar)</th>
                </tr>
            </thead>
            <tbody id="logTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è COLE SUAS CHAVES DO SUPABASE AQUI
    // ==========================================
    const SUPABASE_URL = 'https://uzftppvvshpyoejmptjm.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6ZnRwcHZ2c2hweW9lam1wdGptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODU4NjgsImV4cCI6MjA4NDE2MTg2OH0.lnB46eC4dwQpRYdeJreNLu8vOMGED2GOBLOoO3vnPIs';
    // ==========================================

    let labDB = null;
    const TABLE_MAIN = 'cronograma_lab';
    const TABLE_LOGS = 'daily_logs';
    let globalItems = [];
    let globalLogs = new Map(); // Armazena logs: date -> obs
    let performanceChart = null;

    // Base de Modelos (Imut√°vel)
    const baseModelsList = [
        "IL-MIR 150W_5K", "IL-MIR 80W_5K", "IL-MIR 136W_5K", "IL-MIR 115W_5K", "IL-MIR 100W_5K", "IL-MIR 70W_5K", "IL-MIR 60W_5K", "IL-MIR_50W_5K", "IL-MIR 40W 5K", "IL-MIR 30W 5K",
        "IL-MIR 150W_4K", "IL-MIR 80W_4K", "IL-MIR 136W_4K", "IL-MIR 115W_4K", "IL-MIR 100W 4K", "IL-MIR_70W 4K", "IL-MIR_60W_4K", "IL-MIR_50W_4K", "IL-MIR 40W 4K", "IL-MIR 30W 4K",
        "IL-MIR 150W_2,7K", "IL-MIR 80W_2,7K", "IL-MIR 136W_2,7K", "IL-MIR 115W_2,7K", "IL-MIR 100W 2,7K", "IL-MIR 70W_2,7K", "IL-MIR 60W 2.7K", "IL-MIR 50W 2,7K", "IL-MIR 40W_2,7K", "IL-MIR 30W_2,7K"
    ];

    window.onload = async function() {
        if(SUPABASE_URL.includes('COLE_SUA_URL')) { alert("Configure as chaves do Supabase no c√≥digo HTML!"); return; }
        
        labDB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Load local prefs
        document.getElementById('startDate').value = localStorage.getItem('fq53_start') || new Date().toISOString().split('T')[0];
        document.getElementById('dailyLimit').value = localStorage.getItem('fq53_limit') || 4;

        await fetchData();
    };

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        // Bot√£o ativo visualmente (l√≥gica simplificada via onclick inline no CSS, mas ok)
        if(tab === 'performance') renderPerformance();
    }

    // --- DATA FETCHING ---
    async function fetchData() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        // Fetch Main Data
        const { data: items, error: err1 } = await labDB.from(TABLE_MAIN).select('*');
        // Fetch Logs (Justifications)
        const { data: logs, error: err2 } = await labDB.from(TABLE_LOGS).select('*');

        if (err1 || err2) { alert('Erro de conex√£o com o banco.'); return; }

        // Process Main Items
        globalItems = [];
        const dbMap = new Map(items.map(i => [i.id, i]));

        baseModelsList.forEach((model, mIdx) => {
            for(let i=1; i<=3; i++) {
                let id = `chk_${mIdx}_${i}`;
                let dbData = dbMap.get(id);
                globalItems.push(normalizeItem(id, model, i, 3, false, dbData));
            }
        });

        items.forEach(item => {
            if (item.is_custom) {
                globalItems.push(normalizeItem(item.id, item.model, item.sample_num, item.total_samples, true, item));
            }
        });

        // Process Logs
        globalLogs = new Map();
        if(logs) logs.forEach(l => globalLogs.set(l.date, l.obs));

        renderApp();
        renderPerformance(); // Pre-calculate
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function normalizeItem(id, model, num, total, isCustom, dbData) {
        return {
            id: id, model: model, sampleNum: num, totalSamples: total, isCustom: isCustom,
            isFirst: num === 1,
            done: dbData ? dbData.done : false,
            doneDate: dbData ? dbData.done_date : null,
            obs: dbData ? dbData.obs : ""
        };
    }

    // --- CORE LOGIC ---
    function renderApp() {
        const startStr = document.getElementById('startDate').value;
        const limit = parseInt(document.getElementById('dailyLimit').value);
        localStorage.setItem('fq53_start', startStr); localStorage.setItem('fq53_limit', limit);

        const pending = globalItems.filter(i => !i.done);
        const completed = globalItems.filter(i => i.done).sort((a,b) => new Date(b.doneDate||0) - new Date(a.doneDate||0));

        // Stats Update
        document.getElementById('valTotal').innerText = globalItems.length;
        document.getElementById('valDone').innerText = completed.length;
        document.getElementById('valRemaining').innerText = pending.length;

        // Render Pending Schedule
        const tbody = document.querySelector('#pendingTable tbody');
        tbody.innerHTML = '';
        
        let currentDate = new Date(startStr + 'T00:00:00');
        let today = new Date(); today.setHours(0,0,0,0);
        let qIdx = 0;
        let lastDate = new Date(currentDate);

        if(pending.length === 0) {
            document.getElementById('valFinishDate').innerText = "Conclu√≠do";
            document.getElementById('valDaysLeft').innerText = "0 dias";
            tbody.innerHTML = '<tr><td colspan="3" align="center">üéâ Tudo pronto!</td></tr>';
        } else {
            while(qIdx < pending.length) {
                while(currentDate.getDay()===0 || currentDate.getDay()===6) currentDate.setDate(currentDate.getDate()+1);
                
                const dateKey = currentDate.toISOString().split('T')[0];
                const isToday = currentDate.getTime() === today.getTime();
                
                // Capacity Logic
                let slots = limit;
                if(isToday) {
                    const doneToday = completed.filter(i => i.doneDate === dateKey).length;
                    slots = Math.max(0, limit - doneToday);
                }
                if(currentDate < today) slots = 0; // Past days have 0 capacity for NEW work

                let batch = [];
                for(let i=0; i<slots; i++) {
                    if(qIdx < pending.length) { batch.push(pending[qIdx]); qIdx++; }
                }

                if(batch.length > 0) {
                    const tr = document.createElement('tr');
                    const dateFmt = currentDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                    const weekDay = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][currentDate.getDay()];
                    
                    if(isToday) tr.style.backgroundColor = '#e8f0fe';
                    
                    let html = batch.map(item => `
                        <div class="checklist-item" onclick="toggleItem('${item.id}')">
                            <input type="checkbox" class="item-check" onclick="event.stopPropagation(); toggleItem('${item.id}')">
                            <div>
                                <div style="font-weight:600">${item.model}</div>
                                <div class="item-tags">
                                    <span class="tag">Amostra ${item.sampleNum}/${item.totalSamples}</span>
                                    ${item.isFirst && !item.isCustom ? '<span class="tag tag-new">Novo</span>' : ''}
                                    ${item.isCustom ? '<span class="tag tag-extra">Extra</span>' : ''}
                                </div>
                            </div>
                            <input type="text" class="obs-input" placeholder="Obs..." value="${item.obs||''}" onclick="event.stopPropagation()" onchange="saveObs('${item.id}', this.value)">
                        </div>
                    `).join('');

                    tr.innerHTML = `<td>${dateFmt}</td><td>${isToday ? '<b>HOJE</b>' : weekDay}</td><td>${html}</td>`;
                    tbody.appendChild(tr);
                    lastDate = new Date(currentDate);
                }
                currentDate.setDate(currentDate.getDate()+1);
            }
            
            // Update Occupancy Date
            document.getElementById('valFinishDate').innerText = lastDate.toLocaleDateString('pt-BR');
            const diffTime = lastDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            document.getElementById('valDaysLeft').innerText = diffDays > 0 ? `aprox. ${diffDays} dias corridos` : 'Finaliza Hoje';
        }

        // Render Completed
        const doneBody = document.querySelector('#completedTable tbody');
        doneBody.innerHTML = '';
        completed.forEach(item => {
            const row = document.createElement('tr');
            const dateFmt = item.doneDate ? new Date(item.doneDate).toLocaleDateString('pt-BR') : '-';
            row.innerHTML = `
                <td>${dateFmt}</td>
                <td><b>${item.model}</b> <small style="color:#666">(${item.sampleNum}/${item.totalSamples})</small></td>
                <td><input type="text" class="obs-input" value="${item.obs||''}" onchange="saveObs('${item.id}', this.value)"></td>
            `;
            doneBody.appendChild(row);
        });
    }

    // --- PERFORMANCE & LOGS LOGIC ---
    function renderPerformance() {
        const startStr = document.getElementById('startDate').value;
        const limit = parseInt(document.getElementById('dailyLimit').value);
        const today = new Date(); today.setHours(0,0,0,0);
        let loopDate = new Date(startStr + 'T00:00:00');
        
        // Data Aggregation
        const daysData = [];
        let totalDone = 0;
        let daysCounted = 0;

        // Loop from start until Yesterday (Today is not finished)
        while(loopDate <= today) {
            // Skip FDS
            if(loopDate.getDay() !== 0 && loopDate.getDay() !== 6) {
                const dateKey = loopDate.toISOString().split('T')[0];
                const count = globalItems.filter(i => i.doneDate === dateKey).length;
                const log = globalLogs.get(dateKey) || "";
                
                daysData.push({
                    date: dateKey,
                    dateObj: new Date(loopDate),
                    count: count,
                    target: limit,
                    log: log,
                    status: count >= limit ? 'ok' : (count > 0 ? 'warning' : 'danger')
                });

                if(loopDate < today) { // Count stats only for past full days
                    totalDone += count;
                    daysCounted++;
                }
            }
            loopDate.setDate(loopDate.getDate() + 1);
        }

        // Update KPI Cards
        const avg = daysCounted > 0 ? (totalDone / daysCounted).toFixed(1) : "0.0";
        document.getElementById('perfAvg').innerText = avg;
        document.getElementById('perfTarget').innerText = limit;
        
        const efficiency = daysCounted > 0 ? Math.round((avg / limit) * 100) : 0;
        document.getElementById('perfEfficiency').innerText = efficiency + "%";
        document.getElementById('perfStatusCard').style.borderColor = efficiency >= 80 ? 'var(--success)' : 'var(--warning)';

        // Render Log Table
        const logBody = document.getElementById('logTableBody');
        logBody.innerHTML = '';
        
        // Reverse order (Newest first)
        [...daysData].reverse().forEach(d => {
            const isFuture = d.dateObj > today; // Should not happen due to loop, but safety
            const isToday = d.dateObj.getTime() === today.getTime();
            
            let statusBadge = '';
            let rowStyle = '';
            
            if(isToday) {
                statusBadge = `<span class="badge badge-warning">Em Andamento</span>`;
            } else if (d.count >= d.target) {
                statusBadge = `<span class="badge badge-ok">Meta Batida</span>`;
            } else {
                statusBadge = `<span class="badge badge-danger">Abaixo da Meta</span>`;
                if(!d.log) rowStyle = 'background-color: #fff5f5;'; // Highlight missing justification
            }

            const tr = document.createElement('tr');
            tr.style = rowStyle;
            tr.innerHTML = `
                <td>${d.dateObj.toLocaleDateString('pt-BR')} ${isToday?'(Hoje)':''}</td>
                <td>${d.target}</td>
                <td style="font-weight:bold; font-size:1.1em;">${d.count}</td>
                <td>${statusBadge}</td>
                <td>
                    <input type="text" class="obs-input" 
                           placeholder="${d.count < d.target ? '‚ö†Ô∏è Digite o motivo do atraso...' : 'Observa√ß√µes opcionais...'}" 
                           value="${d.log}" 
                           onchange="saveLog('${d.date}', this.value)"
                           style="${d.count < d.target && !d.log && !isToday ? 'border-color:red;' : ''}">
                </td>
            `;
            logBody.appendChild(tr);
        });

        // Update Chart
        updateChart(daysData);
    }

    function updateChart(data) {
        const ctx = document.getElementById('perfChart').getContext('2d');
        if(performanceChart) performanceChart.destroy();

        // Show last 14 days on chart
        const recentData = data.slice(-14);

        performanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: recentData.map(d => d.dateObj.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})),
                datasets: [
                    {
                        label: 'Realizado',
                        data: recentData.map(d => d.count),
                        backgroundColor: '#0056b3',
                        borderRadius: 4
                    },
                    {
                        label: 'Meta',
                        data: recentData.map(d => d.target),
                        type: 'line',
                        borderColor: '#28a745',
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, max: Math.max(...recentData.map(d=>d.count), 6) + 1 } }
            }
        });
    }

    // --- DATABASE ACTIONS ---
    async function toggleItem(id) {
        const item = globalItems.find(i => i.id === id);
        const newState = !item.done;
        const todayStr = new Date().toISOString().split('T')[0];
        const newDate = newState ? todayStr : null;

        // Optimistic UI
        item.done = newState;
        item.doneDate = newDate;
        renderApp();

        // DB Update
        const payload = {
            id: item.id, model: item.model, sample_num: item.sampleNum,
            total_samples: item.totalSamples, is_custom: item.isCustom,
            done: newState, done_date: newDate, obs: item.obs
        };
        
        const { error } = await labDB.from(TABLE_MAIN).upsert(payload);
        if(error) { console.error(error); alert("Erro ao salvar."); item.done = !newState; renderApp(); }
    }

    async function saveObs(id, text) {
        const item = globalItems.find(i => i.id === id);
        item.obs = text;
        const payload = { ...item, done: item.done }; // Ensure all fields
        // Simplification: just upsert mostly static fields
        await labDB.from(TABLE_MAIN).upsert({
            id: item.id, model: item.model, sample_num: item.sampleNum,
            total_samples: item.totalSamples, is_custom: item.isCustom,
            done: item.done, done_date: item.doneDate, obs: text
        });
    }

    async function saveLog(date, text) {
        globalLogs.set(date, text);
        const { error } = await labDB.from(TABLE_LOGS).upsert({ date: date, obs: text });
        if(error) alert("Erro ao salvar justificativa.");
    }

    function addNewModelPrompt() {
        const name = prompt("Nome do Modelo:");
        if(!name) return;
        const count = parseInt(prompt("Quantidade de Amostras:", "3"));
        if(!count) return;

        const baseId = 'custom_' + Date.now();
        const inserts = [];
        for(let i=1; i<=count; i++) {
            inserts.push({
                id: `${baseId}_${i}`, model: name, sample_num: i, total_samples: count,
                is_custom: true, done: false, done_date: null, obs: ""
            });
        }
        
        labDB.from(TABLE_MAIN).insert(inserts).then(({error}) => {
            if(error) alert("Erro: " + error.message);
            else fetchData();
        });
    }

    async function secureReset() {
        if(prompt("Senha:") === "admin123") {
            await labDB.from(TABLE_MAIN).delete().neq('id', '0');
            await labDB.from(TABLE_LOGS).delete().neq('date', '0');
            location.reload();
        }
    }
</script>

</body>
</html>
